<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TinyMSG | Unified Resonance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=Outfit:wght@900&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/phosphor-icons/1.4.1/duotone/style.min.css">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <style>
        /* VERSION 30.34: TinyMSG SUPER-MAGNIFIED EDITION (2X TEXT & INPUT) */
        :root {
            --primary-blue: #0052ff;
        }

        html, body { 
            height: 100dvh; 
            margin: 0; padding: 0; 
            overflow: hidden;
            background: #f8fafc;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        .chat-container-snapped { 
            width: 95%; 
            max-width: 900px; 
            height: calc(100dvh - 30px); 
            background: white; 
            border-radius: 4rem; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 40px 100px -20px rgba(0,0,0,0.15);
            border: 1px solid #f1f5f9;
            margin: auto;
            position: relative;
        }

        .logo-mark {
            @apply w-12 h-12 md:w-16 md:h-16 bg-[#0052ff] rounded-[1.5rem] flex items-center justify-center text-white font-black text-2xl md:text-3xl shadow-lg shadow-blue-200 rotate-[-10deg];
        }

        .header-title-v34 {
            font-family: 'Outfit', sans-serif;
            @apply text-3xl md:text-5xl font-black tracking-tighter text-slate-900 uppercase italic leading-none;
        }

        .chat-header-prototype {
            padding: 2.5rem;
            @apply md:p-14 md:pb-10;
            background: white;
            border-bottom: 1px solid #f1f5f9;
        }

        .chat-messages-prototype { 
            flex: 1; 
            overflow-y: auto; 
            padding: 2.5rem;
            @apply md:p-14;
            display: flex; 
            flex-direction: column; 
            gap: 2.5rem; /* Doubled Gap */
            background: white;
            font-family: 'Inter', sans-serif;
            -webkit-overflow-scrolling: touch;
        }

        .bubble-apple { 
            max-width: 85%; 
            padding: 1.5rem 2rem;
            @apply md:p-10;
            border-radius: 2.5rem; 
            font-size: 1.25rem; /* ~2X Mobile */
            @apply md:text-3xl; /* ~2X Desktop */
            font-weight: 600; 
            line-height: 1.3;
            position: relative; 
        }

        .bubble-me { 
            align-self: flex-end; 
            background: var(--primary-blue); 
            color: white; 
            border-bottom-right-radius: 0.5rem;
            box-shadow: 0 12px 30px -10px rgba(0,82,255,0.4);
        }

        .bubble-them { 
            align-self: flex-start; 
            background: #f1f5f9; 
            color: #0f172a; 
            border-bottom-left-radius: 0.5rem;
        }

        .input-area-prototype { 
            padding: 2rem 2rem 3rem 2rem;
            @apply md:p-14 md:pt-4;
            background: white; 
        }

        .command-center-telegram { 
            background: white; 
            border-radius: 3rem; 
            padding: 0.75rem;
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
            border: 2px solid #f8fafc;
            margin-left: 0;
            margin-right: 0;
        }

        /* Telegram-style input */
        .field-telegram { 
            flex: 1; 
            background: transparent; 
            border: none; 
            padding: 0.75rem 1rem; 
            font-size: 1.125rem;
            @apply md:text-2xl;
            font-weight: 500;
            outline: none; 
            color: #0f172a;
            width: 90%; /* 10% shorter */
            margin-left: 0.5rem;
        }

        .action-icon-prototype { 
            @apply w-12 h-12 md:w-20 md:h-20 rounded-full;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.06);
            color: #64748b;
            cursor: pointer;
            font-size: 1.5rem;
            @apply md:text-3xl;
        }

        .emoji-bar-prototype {
            display: flex;
            gap: 1.5rem;
            overflow-x: auto;
            padding: 2rem 2.5rem;
            @apply md:px-14;
        }
        .emoji-item { font-size: 3rem; @apply md:text-6xl; cursor: pointer; transition: transform 0.2s; }

        .btn-close-v34 {
            @apply w-16 h-16 md:w-28 md:h-28 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 hover:text-black transition-all text-4xl md:text-6xl;
            margin-right: 2rem;
            transform: translateX(-50%);
        }

        .orange-arrow-btn {
            @apply w-12 h-12 md:w-16 md:h-16 rounded-full bg-[#f97316] flex items-center justify-center text-white cursor-pointer hover:bg-[#fb923c] active:scale-90 transition-transform;
            margin-left: 0.5rem;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
            position: relative;
            z-index: 10;
        }

        ::-webkit-scrollbar { width: 0; background: transparent; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script>
        const { useState, useEffect, useRef, createElement: h } = React;
        const SUPABASE_URL = 'https://cijsxlylkanxmzkteabg.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_cOcjpEDxsX7EH-5cm0ByxA_OqbizsX4';
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function ChatApp() {
            const [session, setSession] = useState(null);
            const [target, setTarget] = useState({id: null, username: ''});
            const [messages, setMessages] = useState([]);
            const [msg, setMsg] = useState('');
            const [recentUsers, setRecentUsers] = useState([]);
            const scrollRef = useRef();

            const EMOJIS = ['ðŸ•Šï¸', 'âœ¨', 'ðŸ§¡', 'ðŸŒ±', 'ðŸ§ ', 'â›µ', 'ðŸŒ‘', 'ðŸ’Ž', 'ðŸ•¯ï¸', 'ðŸ§¿', 'ðŸŒŠ', 'ðŸ”¥', 'ðŸŒ€', 'ðŸ§¬', 'ðŸ¹'];

            useEffect(() => {
                client.auth.getSession().then(({ data }) => setSession(data.session));
                client.auth.onAuthStateChange((_, s) => setSession(s));
            }, []);

            const fetchRecent = async (userId) => {
                if (!userId) return;
                const { data } = await client.from('messages').select('sender_id, receiver_id, sender:sender_id(username), receiver:receiver_id(username)').or(`sender_id.eq.${userId},receiver_id.eq.${userId}`).order('created_at', { ascending: false });
                const uMap = new Map();
                data?.forEach(m => {
                    const other = m.sender_id === userId ? m.receiver : m.sender;
                    if (other && other.username && !uMap.has(other.username)) uMap.set(other.username, other);
                });
                setRecentUsers(Array.from(uMap.values()).slice(0, 5));
            };

            const fetchMsg = async () => {
                if (!target.id || !session) return;
                const { data } = await client.from('messages').select('*').or(`and(sender_id.eq.${session.user.id},receiver_id.eq.${target.id}),and(sender_id.eq.${target.id},receiver_id.eq.${session.user.id})`).order('created_at', { ascending: true });
                setMessages(data || []);
            };

            useEffect(() => {
                if (session) fetchRecent(session.user.id);
            }, [session]);

            useEffect(() => {
                if (target.id) {
                    fetchMsg();
                    const chan = client.channel(`chat-${target.id}`).on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, () => fetchMsg()).subscribe();
                    return () => client.removeChannel(chan);
                }
            }, [target.id, session]);

            useEffect(() => { if (scrollRef.current) scrollRef.current.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

            const link = async (val) => {
                const { data } = await client.from('profiles').select('id, username').eq('username', val.replace(/@/g,'').toLowerCase().trim()).maybeSingle();
                if (data) setTarget({id: data.id, username: "@"+data.username});
            };

            const sendMsg = async () => {
                if (!msg.trim() || !target.id || !session) return;
                const content = msg; setMsg('');
                await client.from('messages').insert([{ sender_id: session.user.id, receiver_id: target.id, content }]);
                fetchMsg();
            };

            if (!session) return h('div', {className: 'flex h-screen items-center justify-center font-black uppercase tracking-widest bg-white text-4xl'}, 'Loading Sync...');

            return h('div', { className: "chat-container-snapped animate__animated animate__zoomIn" },
                h('header', { className: "chat-header-prototype" },
                    h('div', { className: "flex justify-between items-center" },
                        h('div', { className: "flex items-center gap-5 md:gap-8" },
                            h('div', { className: "logo-mark" }, "i"),
                            h('div', null,
                                h('h3', { className: "header-title-v34" }, "TinyMSG"),
                                h('p', { className: "text-lg font-black text-[#0052ff] uppercase tracking-[0.2em] mt-2" }, target.id ? target.username : "Protocol Active")
                            )
                        ),
                        h('div', { className: "flex items-center gap-5 md:gap-8" },
                            !target.id && h('input', { 
                                className: "bg-slate-50 border-2 border-slate-100 rounded-full px-8 py-3 text-xl font-bold outline-none focus:ring-4 ring-blue-100",
                                placeholder: "@soul",
                                onKeyDown: e => e.key === 'Enter' && link(e.target.value)
                            }),
                            h('button', { onClick: () => window.location.href = '/', className: "btn-close-v34 shadow-sm" }, h('i', {className: 'ph-bold ph-x'}))
                        )
                    ),
                    recentUsers.length > 0 && h('div', { className: "flex gap-4 mt-12 overflow-x-auto no-scrollbar" }, 
                        recentUsers.map(u => h('button', { key: u.username, onClick: () => link(u.username), className: "whitespace-nowrap px-8 py-3 rounded-full border-2 border-slate-100 bg-white text-lg font-black text-slate-400 hover:text-[#0052ff]" }, `@${u.username}`))
                    )
                ),

                h('div', { className: "chat-messages-prototype no-scrollbar" },
                    messages.length === 0 && !target.id && h('div', {className: 'flex-1 flex flex-col items-center justify-center text-slate-100'}, h('i', {className: 'ph-duotone ph-broadcast text-[150px] mb-10'}), h('p', {className: 'font-black uppercase tracking-[0.4em] text-2xl'}, 'Awaiting Transmission')),
                    messages.map(m => h('div', { key: m.id, className: `bubble-apple ${m.sender_id === session.user.id ? 'bubble-me' : 'bubble-them'}` }, m.content)),
                    h('div', { ref: scrollRef })
                ),

                h('div', { className: "emoji-bar-prototype no-scrollbar" },
                    EMOJIS.map(e => h('span', { key: e, onClick: () => setMsg(p => p + e), className: "emoji-item" }, e))
                ),

                h('div', { className: "input-area-prototype px-8 py-4" },
                    h('div', { className: "command-center-telegram shadow-lg flex items-center bg-white border border-orange-100" },
                        h('input', { 
                            className: "field-telegram placeholder:text-slate-400", 
                            placeholder: "Type message...",
                            value: msg,
                            onChange: e => setMsg(e.target.value),
                            onKeyDown: e => e.key === 'Enter' && sendMsg()
                        }),
                        h('button', { onClick: sendMsg, className: "orange-arrow-btn" }, h('i', {className: 'ph-bold ph-arrow-up text-lg md:text-2xl'}))
                    )
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(h(ChatApp));
    </script>
</body>
</html>
